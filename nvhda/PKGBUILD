# Maintainer: Xingyang Ni <geeknxy@live.com>

pkgbase=nvhda
pkgname=nvhda-dkms
pkgver=1.0
pkgrel=1
pkgdesc="Kernel driver to dynamically enable/disable NVIDIA HDMI audio output in optimus laptops"
arch=('x86_64')
url="https://github.com/dickmao/nvhda"
license=('GPL')
depends=('linux' 'dkms')
makedepends=('linux-headers')
_extramodules=extramodules-ARCH
source=("git+https://github.com/dickmao/nvhda.git")
md5sums=('SKIP')

build() {
  cd ${pkgbase}
  _kernver="$(cat /usr/lib/modules/${_extramodules}/version)"
  make KDIR=/lib/modules/${_kernver}/build
}

package() {
  cd ${pkgbase}
  install -Dt "${pkgdir}/usr/src/${pkgbase}-${pkgver}" -m644 Makefile nvhda.c dkms/dkms.conf
  install -Dm644 "scripts/nvhda-start.service" "${pkgdir}/usr/lib/systemd/system/nvhda-start.service"
  install -Dm644 "scripts/nvhda-resume.service" "${pkgdir}/usr/lib/systemd/system/nvhda-resume.service"
  install -Dm644 "scripts/nvhda-suspend.service" "${pkgdir}/usr/lib/systemd/system/nvhda-suspend.service"
}